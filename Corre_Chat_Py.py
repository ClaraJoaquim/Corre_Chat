# -*- coding: utf-8 -*-
"""Corre_Chat.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/16uWp2mvJPjvgLQYPwxMCcqV85EExGhPs
"""
import adk
import google
import pip

# Commented out IPython magic to ensure Python compatibility.
# Instala√ß√µes necess√°rias das apis do google para rodar este projeto

# %pip -q install google-genai
!pip install -q google-adk

# Configurar a API Key do Google Gemini

import os
import google.colab

os.environ["GOOGLE_API_KEY"] = userdata.get('GOOGLE_API_KEY')

# Configurar o cliente da SDK do Gemini

from google import genai

client = genai.Client()

MODEL_ID = "gemini-2.0-flash"

from google.adk.agents import Agent
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService
from google.adk.tools import google_search
from google.genai import types  # Para criar conte√∫dos (Content e Part)
import textwrap # Para formatar melhor a sa√≠da de texto
from IPython.display import display, Markdown # Para exibir texto formatado no Colab
import requests # Para fazer requisi√ß√µes HTTP
import warnings

warnings.filterwarnings("ignore")

# Fun√ß√£o auxiliar que envia uma mensagem para um agente via Runner e retorna a resposta final
def call_agent(agent: Agent, message_text: str) -> str:
    # Cria um servi√ßo de sess√£o em mem√≥ria
    session_service = InMemorySessionService()
    # Cria uma nova sess√£o (voc√™ pode personalizar os IDs conforme necess√°rio)
    session = session_service.create_session(app_name=agent.name, user_id="user1", session_id="session1")
    # Cria um Runner para o agente
    runner = Runner(agent=agent, app_name=agent.name, session_service=session_service)
    # Cria o conte√∫do da mensagem de entrada
    content = types.Content(role="user", parts=[types.Part(text=message_text)])

    final_response = ""
    # Itera assincronamente pelos eventos retornados durante a execu√ß√£o do agente
    for event in runner.run(user_id="user1", session_id="session1", new_message=content):
        if event.is_final_response():
          for part in event.content.parts:
            if part.text is not None:
              final_response += part.text
              final_response += "\n"
    return final_response

# Fun√ß√£o auxiliar para exibir texto formatado em Markdown no Colab
def to_markdown(text):
  text = text.replace('‚Ä¢', '  *')
  return Markdown(textwrap.indent(text, '> ', predicate=lambda _: True))

##########################################
# --- Agente 1: Revisor de dados do usu√°rio --- #
##########################################

def agente_revisor_dados(dados):

    revisor_dados = Agent(
        name="agente_revisor_dados",
        model="gemini-2.0-flash",
        instruction="""
        Voc√™ √© um assistente respons√°vel por revisar os dados digitados pelo usu√°rio.
        Caso o usu√°rio informe um n√∫mero irreal de dias por semana para corrida (ex: mais de 7 ou menos de 1),
        ou um tempo exagerado por dia (ex: mais de 5 horas), voc√™ deve substituir por valores gen√©ricos:
        3 dias por semana e 1 hora de treino por dia
        Al√©m disso, se algum dado estiver ausente ou mal formatado, insira o valor padr√£o
        e retorne uma mensagem de aviso sobre a corre√ß√£o.
        """,
        description="Agente que revisa os dados do usu√°rio",
    )

    entrada_do_agente_revisor_dados = f"Dados do usu√°rio: {dados}"

    dados_revisados = call_agent(revisor_dados, entrada_do_agente_revisor_dados)
    return dados_revisados

##########################################
# --- Agente 2: Buscador de Treinos de Corrida --- #
##########################################

def agente_buscador(treino, dados_revisados):

    buscador = Agent(
        name="agente_buscador",
        model="gemini-2.0-flash",
        instruction="""
        Voc√™ √© um assistente especializado em corrida, respons√°vel por pesquisar treinos eficientes de acordo com o perfil do usu√°rio.
        Use a ferramenta de busca do Google (google_search) para encontrar sugest√µes atualizadas e eficazes de treinos de corrida.
        Sempre cumprimente o usu√°rio usando o nome fornecido, mantendo um tom amig√°vel e acolhedor.
        Forne√ßa as informa√ß√µes de forma objetiva e clara ‚Äî sem exagerar nos detalhes, mas garantindo que o usu√°rio saiba como come√ßar.
        Inclua dicas personalizadas conforme os dados revisados do usu√°rio, considerando o objetivo dele com a corrida.
        Evite repetir informa√ß√µes, cite fontes relevantes e use uma linguagem encorajadora.
        """,
        description="Agente que gera informa√ß√µes sobre corrida",
        tools=[google_search]
    )

    entrada_do_agente_buscador = f"Treino: {treino}, Dados Revisados: {dados_revisados}"

    treinos_pesquisados = call_agent(buscador, entrada_do_agente_buscador)
    return treinos_pesquisados

################################################
# --- Agente 3: Planejador de treinos --- #
################################################

def agente_planejador(treinos_pesquisados, treinos_buscados):
    planejador = Agent(
        name="agente_planejador",
        model="gemini-2.0-flash",
        # Inserir as instru√ß√µes do Agente Planejador #################################################
        instruction="""
        Voc√™ √© um planejador de treinos especialista em corrida.
        Com base na lista de treinos fornecida pelo agente buscador, seu papel √© organizar e criar um plano de treino personalizado para o usu√°rio.
        Explique detalhadamente o que √© cada treino, seus benef√≠cios e para que serve.
        No final, selecione os treinos mais relevantes para o objetivo do usu√°rio e retorne esse plano de forma clara e objetiva.
        Caso precise, voc√™ pode usar a ferramenta de busca do Google (google_search) para complementar informa√ß√µes espec√≠ficas.
        Mantenha um tom encorajador e amig√°vel.
        """,
        description="Agente que planeja treinos",
        tools=[google_search]
    )

    entrada_do_agente_planejador = f"Treino: {treinos_pesquisados}, Treinos buscados: {treinos_buscados}"
    # Executa o agente
    plano_do_treino = call_agent(planejador, entrada_do_agente_planejador)
    return plano_do_treino

######################################
# --- Agente 4: Treinador de Corrida --- #
######################################

def agente_treinador(plano_do_treino, plano_de_treino):
    treinador = Agent(
        name="agente_treinador",
        model="gemini-2.0-flash",
        instruction="""
        Voc√™ √© um treinador especializado em treinos de corrida para todos os n√≠veis: iniciantes, intermedi√°rios e avan√ßados.
        Utilize os treinos mais relevantes do plano fornecido para criar uma planilha rascunhada de 4 semanas de treinos.
        A planilha deve ser organizada com colunas representando as semanas (Semana 1, Semana 2, Semana 3, Semana 4)
        e linhas representando os dias da semana (segunda, ter√ßa, quarta, quinta, sexta, s√°bado e domingo).
        Personalize o plano conforme as necessidades e n√≠vel do usu√°rio, garantindo que os treinos sejam adequados e progressivos.
        Obs: Se algum dia da semana n√£o tiver treino previsto, escreva explicitamente ‚ÄòDescanso‚Äô. Nunca deixe campos em branco.
        Use um tom motivacional e encorajador para ajudar o usu√°rio a se sentir confiante para seguir o plano.
        """,
        description="Agente especializado em organizar treinos de corrida"
    )
    entrada_do_agente_treinador = f"Treinos: {plano_do_treino}, Plano de treino: {plano_de_treino}"

    rascunho = call_agent(treinador, entrada_do_agente_treinador)
    return rascunho

##########################################
# --- Agente 5: Revisor de Treinos --- #
##########################################

def agente_revisor_planilha(rascunho, planilha_gerada):
    revisor = Agent(
        name="agente_revisor_planilha",
        model="gemini-2.0-flash",
        instruction="""
          Voc√™ √© um revisor de planilhas de treino especializado em corrida.
          Revise o conte√∫do da planilha abaixo observando os seguintes aspectos:
          Clareza (as instru√ß√µes est√£o f√°ceis de entender?)
          Concis√£o (sem repeti√ß√µes desnecess√°rias?)
          Corre√ß√£o (h√° erros ou inconsist√™ncias?)
          Tom (o plano motiva e respeita o n√≠vel do usu√°rio?)
          Obs: N√£o considere o uso da palavra "descanso" como repeti√ß√£o desnecess√°ria, ela √©
          essencial na planilha para indicar dias de recupera√ß√£o e deve aparecer sempre que necess√°rio.
          Se tudo estiver √≥timo, responda apenas: 'A planilha est√° √≥tima e pronta para usar!'.
          Caso contr√°rio, liste os pontos que precisam ser melhorados e d√™ sugest√µes claras.
            """,
        description="Agente revisor de treinos para corrida."
    )
    entrada_do_agente_revisor = f"Treinos: {rascunho}\nPlanilha: {planilha_gerada}"

    texto_revisado = call_agent(revisor, entrada_do_agente_revisor)
    return texto_revisado

#############################################
# --- Agente 6: Finalizador de Planilha --- #
#############################################

def agente_finalizador(treinos, planilha_original, revisao):
    finalizador = Agent(
        name="agente_finalizador",
        model="gemini-2.0-flash",
        instruction="""
        Voc√™ √© um especialista em finalizar planilhas de treino de corrida.
        Sua tarefa √© revisar a planilha original com base na resposta do revisor.
        Se a revis√£o disser que est√° tudo certo (ex: "A planilha est√° √≥tima e pronta para usar!"), apenas retorne a planilha original.
        Se houver sugest√µes de melhoria, voc√™ deve aplicar essas sugest√µes na planilha, mantendo o formato original:
        Colunas: Semana 1, Semana 2, Semana 3, Semana 4
        Linhas: Segunda, Ter√ßa, Quarta, Quinta, Sexta, S√°bado, Domingo
        A nova vers√£o da planilha deve ser clara, organizada e adequada ao perfil do usu√°rio.
        """,
        description="Agente respons√°vel por aplicar revis√µes e finalizar a planilha de treinos."
    )
    entrada_do_agente_finalizador = f"Treinos originais: {treinos}, Planilha original: {planilha_original}, Revis√£o: {revisao}"

    planilha_final = call_agent(finalizador, entrada_do_agente_finalizador)
    return planilha_final

print(" üèÅ Bem-vindo ao seu Treinador de Corridas Personalizado! üèÉ‚Äç‚ôÄÔ∏è")

# --- Obter dados do usu√°rio ---

print("\nPor favor, informe os dados abaixo: \n")

nome = input("Qual √© o seu nome? ")
while not nome:
  nome = input("Por favor, informe um nome v√°lido.\nQual √© o seu nome? ")


idade = input("\nQual a sua idade? ")
while not idade:
  idade = input("Por favor, informe uma idade v√°lida.\nQual √© o sua idade? ")


nivel = input("\nComo voc√™ descreveria sua experi√™ncia atual na corrida? (Iniciante, Intermedi√°rio, Avan√ßado) ")
while not nivel:
  nivel = input("Por favor, informe sua experiencia na corrida: ")


semanas = int(input("\nEm quantos dias da semana voc√™ pretende treinar corrida? "))
while not semanas:
    semanas = int(input("Por favor, quantos dias da semana voc√™ pretende treinar corrida: "))


dia = input("\nEm quais dias da semana voc√™ geralmente pode treinar? (Ex: Seg, Qua, Sex) ")
while not dia:
    dia = input("Por favor, informe os dias da semana que voc√™ pode treinar: ")


tempo = input("\nEm m√©dia, quanto tempo voc√™ dedica a cada treino de corrida? ")
while not tempo:
    tempo = input("Por favor, informe quanto tempo voc√™ dedica a cada sess√£o de corrida: ")


objetivo = input("\nQual √© o seu principal objetivo com a corrida atualmente? (Ex: Correr uma prova de 5km, melhorar meu tempo em 10km, sentir mais disposi√ß√£o, etc.) ")
while not objetivo:
    objetivo = input("Por favor, informe seu objetivo com a corrida: ")


observacao = input("\nGostaria de adicionar alguma informa√ß√£o relevante sobre sua sa√∫de, hist√≥rico de les√µes ou outras considera√ß√µes para o seu treino? ")


# --- Armazenar os dados do usu√°rio em apenas uma vari√°vel ---
user_message = f"""
Nome: {nome}
Idade: {idade}
Nivel: {nivel}
Dias de treino por semana: {semanas}
Tempo de treino por dia: {tempo}
Dia da semana: {dia}
Objetivo: {objetivo}
Observa√ß√£o: {observacao}
"""

# Inserir l√≥gica do sistema de agentes ################################################

print("\nCerto! Criaremos seu plano de corrida personalizado! üí™")

revisor_dados = agente_revisor_dados(user_message)
print("\n--- ‚úÖ Resultado do revisor de dados ---\n")
display(to_markdown(revisor_dados))
print("--------------------------------------------------------------")

treinos_buscados = agente_buscador(user_message, revisor_dados)
print("\n--- ‚úÖ Resultado da busca de treinos  ---\n")
display(to_markdown(treinos_buscados))
print("--------------------------------------------------------------")

plano_de_treino = agente_planejador(user_message, treinos_buscados)
print("\n--- ‚úÖ Resultado do planejador de treinos ---\n")
display(to_markdown(plano_de_treino))
print("--------------------------------------------------------------")

rascunho_de_treino = agente_treinador(user_message, plano_de_treino)
print("\n--- ‚úÖ Resultado do rascunho de treinos ---\n")
display(to_markdown(rascunho_de_treino))
print("--------------------------------------------------------------")

revisor = agente_revisor_planilha(user_message, rascunho_de_treino)
print("\n--- ‚úÖ Resultado do revisor de treinos ---\n")
display(to_markdown(revisor))
print("--------------------------------------------------------------")

planilha_final = agente_finalizador(user_message, rascunho_de_treino, revisor)
print("\n--- ‚úÖ Resultado da planilha final ---\n")
print("\nüéâ Seu plano de corrida personalizado est√° pronto! Consulte abaixo:")
display(to_markdown(planilha_final))
print("\nBoa corrida! üòÑ")
print("--------------------------------------------------------------")